import{instanciarAnalizadorLexicoGramaticas,parseAFDFile}from"./parser_utils.js";import{Grammar}from"./grammar.js";import{AnalizadorLexico,SimbolosEspeciales}from"./analizador_lexico.js";import{leerArchivo}from"./file_utils.js";import{agregarFilaLexResults,limpiarTablasSimbolos}from"./dom_utils.js";import{generarTablaLL1}from"./sintactic_ll1.js";const appState={userAutomata:null,userLexAnalyzer:null,currentGrammar:null,grammarUpdateTimeout:null,currentMode:"lex",ll1Table:null,tokensAssigned:!1};async function actualizarGrammarDesdeTexto(){const e=document.getElementById("grammarText").value.trim();if(""===e)return void limpiarTablasSimbolos();const t=await instanciarAnalizadorLexicoGramaticas(e);if(!t)return void limpiarTablasSimbolos();const a=new Grammar(t);await a.parse()?actualizarTablasDeSimbolos(a):limpiarTablasSimbolos()}function actualizarTablasDeSimbolos(e){e.updateNodos();const t=document.getElementById("noterm"),a=document.getElementById("term");t.innerHTML="",a.innerHTML="",appState.currentGrammar=e;const r=new Set(e.SimbNoTerm),l=new Set;for(let t=0;t<e.NumReglas;t++)for(let a of e.Reglas[t].Lista)a.EsTerminal&&"ε"!==a.NombSimb&&l.add(a.NombSimb);r.forEach((e=>{t.insertRow().insertCell().textContent=e})),l.forEach((e=>{const t=a.insertRow();t.insertCell().textContent=e;const r=t.insertCell(),l=document.createElement("input");l.type="text",l.size=5,l.placeholder="Token",appState.currentGrammar.TerminalesTokens[e]&&(l.value=appState.currentGrammar.TerminalesTokens[e]),r.appendChild(l)}))}function obtenerTerminalesSinToken(e){const t=new Set;for(let a=0;a<e.NumReglas;a++)for(let r of e.Reglas[a].Lista)r.EsTerminal&&"ε"!==r.NombSimb&&t.add(r.NombSimb);const a=[];for(let r of t)void 0===e.TerminalesTokens[r]&&a.push(r);return a}function mostrarTablaLL1EnInterfaz(e){const t=document.querySelector(".table-results__table");t.innerHTML="";const a=appState.currentGrammar,r=a.Reglas.map(((e,t)=>{const a=e.Lista.map((e=>e.NombSimb)).join(" ");return e.NombSimb+" -> "+a})),l=Object.keys(e),n=new Set;for(let t of l)for(let a of Object.keys(e[t]))n.add(a);const o=Array.from(n),s=t.insertRow();s.classList.add("ll1-header-row");let i=s.insertCell();i.textContent="NT/TOK",i.classList.add("ll1-header-cell");for(let e of o){const t=s.insertCell();t.textContent=e,t.classList.add("ll1-header-cell")}for(let a of l){const l=t.insertRow();l.classList.add("ll1-row");const n=l.insertCell();n.textContent=a,n.classList.add("ll1-nonterminal-cell");for(let t of o){const n=l.insertCell();if(n.classList.add("ll1-cell"),void 0!==e[a][t]){const l=e[a][t];n.textContent=r[l],n.classList.add("ll1-rule-cell")}else n.textContent="",n.classList.add("ll1-empty-cell")}}const c=new Set;for(let e=0;e<a.NumReglas;e++)for(let t of a.Reglas[e].Lista)t.EsTerminal&&"ε"!==t.NombSimb&&c.add(t.NombSimb);const m=Array.from(c),d=document.querySelector(".table-results__expand");d.innerHTML="";const p=document.createElement("table");p.classList.add("table-results__table","ll1-second-table"),d.appendChild(p);const u=p.insertRow();let g=u.insertCell();g.textContent="Term/Term",g.classList.add("ll1-header-cell");for(let e of m){const t=u.insertCell();t.textContent=e,t.classList.add("ll1-header-cell")}for(let e of m){const t=p.insertRow(),a=t.insertCell();a.textContent=e,a.classList.add("ll1-terminal-cell");for(let a of m){const r=t.insertCell();r.classList.add("ll1-action-cell"),e===a?(r.textContent="pop",r.classList.add("ll1-pop-cell")):(r.textContent="error",r.classList.add("ll1-error-cell"))}}}function analizarSintacticamente(e,t,a,r){const l=new AnalizadorLexico(e,r);let n,o=[],s=[];for(;0!==(n=l.yylex())&&n!==SimbolosEspeciales.ERROR;)o.push(n),s.push(l.getLexema());if(n===SimbolosEspeciales.ERROR)return[{stack:"",input:e,operation:"Error léxico"}];o.push("FIN"),s.push("$");let i=["FIN",t.Reglas[0].NombSimb],c=[],m=0;function d(){return i.slice().reverse().join(" ")}function p(){return s.slice(m).join(" ")}for(c.push({stack:d(),input:p(),operation:"Iniciar"});;){let e=i[i.length-1],r=o[m],l=s[m];if("FIN"===e&&"FIN"===r){c.push({stack:d(),input:p(),operation:"aceptar"});break}if("ε"!==e)if(esTerminal(e,t)){if(e!==l&&"$"!==e&&t.TerminalesTokens[e]!==r){c.push({stack:d(),input:p(),operation:"error"});break}i.pop(),m++,c.push({stack:d(),input:p(),operation:"pop"})}else{let l=r,n=a[e][l];if(void 0===n){c.push({stack:d(),input:p(),operation:"error"});break}i.pop();const o=t.Reglas[n],s=o.Lista.map((e=>e.NombSimb)).join(" ");for(let e=o.Lista.length-1;e>=0;e--){let t=o.Lista[e].NombSimb;i.push(t)}c.push({stack:d(),input:p(),operation:e+" -> "+s})}else i.pop(),c.push({stack:d(),input:p(),operation:"Desapilar ε"})}return c}function esTerminal(e,t){return"FIN"!==e&&("ε"===e||!t.SimbNoTerm.has(e))}document.addEventListener("DOMContentLoaded",(async()=>{const e=document.getElementById("matrizInput"),t=document.getElementById("cargarAFD"),a=document.getElementById("testLex"),r=document.getElementById("lexResults"),l=document.getElementById("grammarText"),n=document.getElementById("asignarTokens"),o=document.getElementById("crearTablaLL1"),s=document.getElementById("analizlex"),i=document.getElementById("analizsintact"),c=document.getElementById("lex"),m=document.getElementById("sintact");let d=document.createElement("button");d.textContent="Ir a asignación de tokens",d.className="info__button",d.style.display="none",document.getElementById("lex").appendChild(d),i.disabled=!0,a.disabled=!0,n.disabled=!0,o.disabled=!0,c.style.display="block",m.style.display="none",a.textContent="Analizar Léxicamente",appState.currentMode="lex",s.checked=!0,s.addEventListener("change",(()=>{s.checked&&(c.style.display="block",m.style.display="none",a.textContent="Analizar Léxicamente",appState.currentMode="lex")})),i.addEventListener("change",(()=>{i.checked&&(c.style.display="none",m.style.display="block",a.textContent="Analizar Sintácticamente",appState.currentMode="sintact")})),t.addEventListener("click",(()=>{e.click()})),e.addEventListener("change",(async e=>{const t=e.target.files[0];if(t)try{const e=await leerArchivo(t);appState.userAutomata=parseAFDFile(e),appState.userLexAnalyzer=new AnalizadorLexico("",appState.userAutomata),console.log("Autómata cargado exitosamente."),a.disabled=!1,alert("AFD Cargado. Ahora puede realizar análisis léxico."),a.classList.add("highlight");const r=document.getElementById("lex");r&&r.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error al cargar el autómata:",e),alert("Error al cargar el autómata. Ver consola para detalles.")}})),a.addEventListener("click",(()=>{const e=document.getElementById("sigma").value.trim();if("lex"===appState.currentMode){if(!appState.userLexAnalyzer)return void alert("Primero carga el AFD.");let t;for(r.innerHTML="",appState.userLexAnalyzer.setSigma(e);0!==(t=appState.userLexAnalyzer.yylex())&&t!==SimbolosEspeciales.ERROR;){const e=appState.userLexAnalyzer.getLexema();agregarFilaLexResults(r,e,t)}0===t?(console.log("Fin de entrada (análisis usuario)."),agregarFilaLexResults(r,"FIN","0"),alert("Análisis léxico completado. Ahora asigne tokens a los terminales."),d.style.display="block",a.classList.remove("highlight"),d.classList.add("highlight")):t===SimbolosEspeciales.ERROR&&(agregarFilaLexResults(r,appState.userLexAnalyzer.getLexema(),"ERROR"),alert("Error léxico encontrado, revise su cadena sigma."))}else{if(!appState.userLexAnalyzer)return void alert("No se ha cargado el AFD.");if(!appState.ll1Table||!appState.currentGrammar)return void alert("No se ha generado la tabla LL1. Por favor genera la tabla LL1 primero.");const t=document.querySelector("#sintact .result__table");t.innerHTML="";const a=analizarSintacticamente(e,appState.currentGrammar,appState.ll1Table,appState.userAutomata),r=t.insertRow();r.insertCell().textContent="Pila",r.insertCell().textContent="Sigma",r.insertCell().textContent="Operación";for(let e of a){const a=t.insertRow();a.insertCell().textContent=e.stack,a.insertCell().textContent=e.input,a.insertCell().textContent=e.operation}}})),d.addEventListener("click",(()=>{document.querySelector(".info").scrollIntoView({behavior:"smooth"}),d.classList.remove("highlight"),n.disabled=!1,n.classList.add("highlight")})),l.addEventListener("input",(()=>{appState.grammarUpdateTimeout&&clearTimeout(appState.grammarUpdateTimeout),appState.grammarUpdateTimeout=setTimeout((()=>{actualizarGrammarDesdeTexto()}),500)})),n.addEventListener("click",(()=>{if(!appState.currentGrammar)return void console.warn("No hay una gramática parseada actualmente.");const e=document.getElementById("term");let t=!0;for(let a=0;a<e.rows.length;a++){const r=e.rows[a],l=r.cells[0].textContent,n=r.cells[1].querySelector('input[type="text"]').value.trim();""===n||isNaN(n)?(delete appState.currentGrammar.TerminalesTokens[l],t=!1):appState.currentGrammar.TerminalesTokens[l]=parseInt(n,10)}console.log("Asignaciones de tokens a terminales:");for(let[e,t]of Object.entries(appState.currentGrammar.TerminalesTokens))console.log(e,"->",t);t?(alert("Tokens asignados correctamente."),appState.tokensAssigned=!0,n.classList.remove("highlight"),o.disabled=!1,o.classList.add("highlight")):alert("Algunos terminales no tienen token asignado.")})),o.addEventListener("click",(()=>{if(!appState.currentGrammar)return void alert("No hay una gramática parseada. Por favor, escribe una gramática válida.");const e=obtenerTerminalesSinToken(appState.currentGrammar);e.length>0?alert("Los siguientes terminales no tienen token asignado: "+e.join(", ")):appState.userAutomata?(appState.currentGrammar.removeLeftRecursion(),appState.ll1Table=generarTablaLL1(appState.currentGrammar),console.log("Tabla LL1 generada:"),console.log(appState.ll1Table),mostrarTablaLL1EnInterfaz(appState.ll1Table),alert("Tabla LL1 generada con éxito. Ahora puede realizar el análisis sintáctico."),o.classList.remove("highlight"),i.disabled=!1,document.querySelector(".table-results").scrollIntoView({behavior:"smooth"})):alert("No se ha cargado el archivo de la matriz de transición AFD.")}))}));
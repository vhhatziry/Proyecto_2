import{instanciarAnalizadorLexicoGramaticas,parseAFDFile}from"./parser_utils.js";import{Grammar}from"./grammar.js";import{AnalizadorLexico,SimbolosEspeciales}from"./analizador_lexico.js";import{leerArchivo}from"./file_utils.js";import{agregarFilaLexResults,limpiarTablasSimbolos}from"./dom_utils.js";import{generarTablaLL1}from"./sintactic_ll1.js";const appState={userAutomata:null,userLexAnalyzer:null,currentGrammar:null,grammarUpdateTimeout:null,currentMode:"lex",ll1Table:null};async function actualizarGrammarDesdeTexto(){const e=document.getElementById("grammarText").value.trim();if(""===e)return void limpiarTablasSimbolos();const t=await instanciarAnalizadorLexicoGramaticas(e);if(!t)return void limpiarTablasSimbolos();const a=new Grammar(t);await a.parse()?actualizarTablasDeSimbolos(a):limpiarTablasSimbolos()}function actualizarTablasDeSimbolos(e){e.updateNodos(),appState.currentGrammar=e;const t=document.getElementById("noterm"),a=document.getElementById("term");t.innerHTML="",a.innerHTML="";const r=new Set(e.SimbNoTerm),n=new Set;for(let t=0;t<e.NumReglas;t++)for(let a of e.Reglas[t].Lista)a.EsTerminal&&"ε"!==a.NombSimb&&n.add(a.NombSimb);r.forEach((e=>{t.insertRow().insertCell().textContent=e})),n.forEach((e=>{const t=a.insertRow();t.insertCell().textContent=e;const r=t.insertCell(),n=document.createElement("input");n.type="text",n.size=5,n.placeholder="Token",appState.currentGrammar.TerminalesTokens[e]&&(n.value=appState.currentGrammar.TerminalesTokens[e]),r.appendChild(n)}))}function obtenerTerminalesSinToken(e){const t=new Set;for(let a=0;a<e.NumReglas;a++)for(let r of e.Reglas[a].Lista)r.EsTerminal&&"ε"!==r.NombSimb&&t.add(r.NombSimb);const a=[];for(let r of t)void 0===e.TerminalesTokens[r]&&a.push(r);return a}function mostrarTablaLL1EnInterfaz(e){const t=document.querySelector(".table-results__table");t.innerHTML="";const a=appState.currentGrammar,r=a.Reglas.map(((e,t)=>{const a=e.Lista.map((e=>e.NombSimb)).join(" ");return e.NombSimb+" -> "+a})),n=Object.keys(e),l=new Set;for(let t of n)for(let a of Object.keys(e[t]))l.add(a);const o=Array.from(l),s=t.insertRow();s.classList.add("ll1-header-row");let i=s.insertCell();i.textContent="NT/TOK",i.classList.add("ll1-header-cell");for(let e of o){const t=s.insertCell();t.textContent=e,t.classList.add("ll1-header-cell")}for(let a of n){const n=t.insertRow();n.classList.add("ll1-row");const l=n.insertCell();l.textContent=a,l.classList.add("ll1-nonterminal-cell");for(let t of o){const l=n.insertCell();if(l.classList.add("ll1-cell"),void 0!==e[a][t]){const n=e[a][t];l.textContent=r[n],l.classList.add("ll1-rule-cell")}else l.textContent="",l.classList.add("ll1-empty-cell")}}const c=new Set;for(let e=0;e<a.NumReglas;e++)for(let t of a.Reglas[e].Lista)t.EsTerminal&&"ε"!==t.NombSimb&&c.add(t.NombSimb);const m=Array.from(c),d=document.querySelector(".table-results__expand");d.innerHTML="";const p=document.createElement("table");p.classList.add("table-results__table","ll1-second-table"),d.appendChild(p);const u=p.insertRow();let g=u.insertCell();g.textContent="Term/Term",g.classList.add("ll1-header-cell");for(let e of m){const t=u.insertCell();t.textContent=e,t.classList.add("ll1-header-cell")}for(let e of m){const t=p.insertRow(),a=t.insertCell();a.textContent=e,a.classList.add("ll1-terminal-cell");for(let a of m){const r=t.insertCell();r.classList.add("ll1-action-cell"),e===a?(r.textContent="pop",r.classList.add("ll1-pop-cell")):(r.textContent="error",r.classList.add("ll1-error-cell"))}}}function analizarSintacticamente(e,t,a,r){const n=new AnalizadorLexico(e,r);let l,o=[],s=[];for(;0!==(l=n.yylex())&&l!==SimbolosEspeciales.ERROR;)o.push(l),s.push(n.getLexema());if(l===SimbolosEspeciales.ERROR)return[{stack:"",input:e,operation:"Error léxico"}];o.push("FIN"),s.push("$");let i=["FIN",t.Reglas[0].NombSimb],c=[],m=0;function d(){return i.slice().reverse().join(" ")}function p(){return s.slice(m).join(" ")}for(c.push({stack:d(),input:p(),operation:"Iniciar"});;){let e=i[i.length-1],r=o[m],n=s[m];if("FIN"===e&&"FIN"===r){c.push({stack:d(),input:p(),operation:"aceptar"});break}if("ε"!==e)if(esTerminal(e,t)){if(e!==n&&"$"!==e&&t.TerminalesTokens[e]!==r){c.push({stack:d(),input:p(),operation:"error"});break}i.pop(),m++,c.push({stack:d(),input:p(),operation:"pop"})}else{let n=r,l=a[e][n];if(void 0===l){c.push({stack:d(),input:p(),operation:"error"});break}i.pop();const o=t.Reglas[l],s=o.Lista.map((e=>e.NombSimb)).join(" ");for(let e=o.Lista.length-1;e>=0;e--){let t=o.Lista[e].NombSimb;i.push(t)}c.push({stack:d(),input:p(),operation:e+" -> "+s})}else i.pop(),c.push({stack:d(),input:p(),operation:"Desapilar ε"})}return c}function esTerminal(e,t){return"FIN"!==e&&("ε"===e||!t.SimbNoTerm.has(e))}document.querySelectorAll(".info__sections__select input").forEach((e=>{e.addEventListener("click",(()=>{document.querySelector(".result").scrollIntoView({behavior:"smooth"})}))})),document.addEventListener("DOMContentLoaded",(async()=>{const e=document.getElementById("matrizInput"),t=document.getElementById("cargarAFD"),a=document.getElementById("testLex"),r=document.getElementById("lexResults"),n=document.getElementById("grammarText"),l=document.getElementById("asignarTokens"),o=document.getElementById("crearTablaLL1"),s=document.getElementById("analizlex"),i=document.getElementById("analizsintact"),c=document.getElementById("lex"),m=document.getElementById("sintact");a.disabled=!0,c.style.display="block",m.style.display="none",a.textContent="Analizar Léxicamente",appState.currentMode="lex",s.addEventListener("change",(()=>{s.checked&&(c.style.display="block",m.style.display="none",a.textContent="Analizar Léxicamente",appState.currentMode="lex")})),i.addEventListener("change",(()=>{i.checked&&(c.style.display="none",m.style.display="block",a.textContent="Analizar Sintácticamente",appState.currentMode="sintact")})),t.addEventListener("click",(()=>{e.click(),e.addEventListener("change",(()=>{alert("AFD Cargado")}))})),e.addEventListener("change",(async e=>{const t=e.target.files[0];if(t)try{const e=await leerArchivo(t);appState.userAutomata=parseAFDFile(e),appState.userLexAnalyzer=new AnalizadorLexico("",appState.userAutomata),console.log("Autómata cargado exitosamente."),a.disabled=!1}catch(e){console.error("Error al cargar el autómata:",e),alert("Error al cargar el autómata. Ver consola para detalles.")}})),a.addEventListener("click",(()=>{const e=document.getElementById("sigma").value.trim();if("lex"===appState.currentMode){if(!appState.userLexAnalyzer)return void alert("Primero carga el AFD.");let t;for(r.innerHTML="",appState.userLexAnalyzer.setSigma(e);0!==(t=appState.userLexAnalyzer.yylex())&&t!==SimbolosEspeciales.ERROR;){const e=appState.userLexAnalyzer.getLexema();agregarFilaLexResults(r,e,t)}0===t?(console.log("Fin de entrada (análisis usuario)."),agregarFilaLexResults(r,"FIN","0")):t===SimbolosEspeciales.ERROR&&agregarFilaLexResults(r,appState.userLexAnalyzer.getLexema(),"ERROR")}else{if(!appState.userLexAnalyzer)return void alert("No se ha cargado el AFD.");if(!appState.ll1Table||!appState.currentGrammar)return void alert("No se ha generado la tabla LL1. Por favor genera la tabla LL1 primero.");const t=document.querySelector("#sintact .result__table");t.innerHTML="";const a=analizarSintacticamente(e,appState.currentGrammar,appState.ll1Table,appState.userAutomata),r=t.insertRow();r.insertCell().textContent="Pila",r.insertCell().textContent="Sigma",r.insertCell().textContent="Operación";for(let e of a){const a=t.insertRow();a.insertCell().textContent=e.stack,a.insertCell().textContent=e.input,a.insertCell().textContent=e.operation}}})),n.addEventListener("input",(()=>{appState.grammarUpdateTimeout&&clearTimeout(appState.grammarUpdateTimeout),appState.grammarUpdateTimeout=setTimeout((()=>{actualizarGrammarDesdeTexto()}),500)})),l.addEventListener("click",(()=>{if(!appState.currentGrammar)return void console.warn("No hay una gramática parseada actualmente.");const e=document.getElementById("term");for(let t=0;t<e.rows.length;t++){const a=e.rows[t],r=a.cells[0].textContent,n=a.cells[1].querySelector('input[type="text"]').value.trim();""===n||isNaN(n)?delete appState.currentGrammar.TerminalesTokens[r]:appState.currentGrammar.TerminalesTokens[r]=parseInt(n,10)}console.log("Asignaciones de tokens a terminales:");for(let[e,t]of Object.entries(appState.currentGrammar.TerminalesTokens))console.log(e,"->",t);alert("Tokens asignados")})),o.addEventListener("click",(()=>{if(!appState.currentGrammar)return void alert("No hay una gramática parseada. Por favor, escribe una gramática válida.");const e=obtenerTerminalesSinToken(appState.currentGrammar);e.length>0?alert("Los siguientes terminales no tienen token asignado: "+e.join(", ")):appState.userAutomata?(appState.currentGrammar.removeLeftRecursion(),appState.ll1Table=generarTablaLL1(appState.currentGrammar),console.log("Tabla LL1 generada:"),console.log(appState.ll1Table),mostrarTablaLL1EnInterfaz(appState.ll1Table),alert("Tabla LL1 generada con éxito. Revisa la sección de resultados para verla.Y despues seleccione una forma de análisis."),document.querySelector(".table-results").scrollIntoView({behavior:"smooth"})):alert("No se ha cargado el archivo de la matriz de transición AFD.")}))}));